import tkinter as tk
from tkinter import ttk, colorchooser, filedialog, messagebox
from PIL import Image, ImageTk
import fitz  # PyMuPDF
import os
import io
import math

def center_window(root, width=400, height=200):
    screen_width = root.winfo_screenwidth()
    screen_height = root.winfo_screenheight()
    x = (screen_width - width) // 2
    y = (screen_height - height) // 2
    root.geometry(f"{width}x{height}+{x}+{y}")

class SplashScreen:
    def __init__(self, root):
        self.root = root
        self.root.title("Ametch Pen")
        self.root.configure(bg="#87CEEB")  # Açık mavi arka plan
        center_window(self.root, 400, 200)
        self.root.resizable(False, False)
        
        # Giriş ekranı içeriği
        self.label = tk.Label(root, text="Ametch Pen", font=("Arial", 24, "bold"), bg="#87CEEB")
        self.label.pack(pady=20)
        
        self.author = tk.Label(root, text="Yapımcı: Ahmet Efe Kayahan", font=("Arial", 12), bg="#87CEEB")
        self.author.pack(pady=10)
        
        self.version = tk.Label(root, text="Sürüm: 1.1", font=("Arial", 10), bg="#87CEEB")
        self.version.pack(pady=10)
        
        # Loading animasyonu (yuvarlak)
        self.canvas = tk.Canvas(root, width=70, height=70, bg="#87CEEB", highlightthickness=0)
        self.canvas.pack(side=tk.BOTTOM, pady=30)  # Yukarı taşıma için pady artırıldı
        self.angle = 0
        self.oval_id = self.canvas.create_oval(5, 5, 65, 65, outline="#FF4500", width=4)  # Daha büyük ve kontrast yuvarlak
        self.animate_loading()
        
        # 5 saniye sonra kapanır
        self.root.after(5000, self.close_splash)

    def animate_loading(self):
        if not hasattr(self, 'root') or not self.root.winfo_exists():
            return
        self.angle = (self.angle + 10) % 360
        x0 = 35 + math.cos(math.radians(self.angle)) * 25
        y0 = 35 + math.sin(math.radians(self.angle)) * 25
        x1 = 35 - math.cos(math.radians(self.angle)) * 25
        y1 = 35 - math.sin(math.radians(self.angle)) * 25
        self.canvas.coords(self.oval_id, x0, y0, x1, y1)
        self.canvas.after(50, self.animate_loading)

    def close_splash(self):
        self.root.destroy()

class DrawingApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Kalem Uygulaması")
        self.root.configure(bg="#F0F0F0")  # Yumuşak gri arka plan
        center_window(self.root, 1200, 800)
        self.root.resizable(True, True)
        
        # Stil için modern tema
        style = ttk.Style()
        style.theme_use('clam')
        style.configure('TButton', padding=6, relief="flat", background="#E0E0E0")
        style.configure('TLabel', padding=6)
        style.configure('TEntry', padding=6)
        
        # Araç çubuğu
        self.toolbar = ttk.Frame(self.root)
        self.toolbar.pack(side=tk.TOP, fill=tk.X)
        
        # Butonlar
        self.load_btn = ttk.Button(self.toolbar, text="Dosya Yükle (PDF/PNG)", command=self.load_file)
        self.load_btn.pack(side=tk.LEFT, padx=5)
        
        self.color_btn = ttk.Button(self.toolbar, text="Renk Seç", command=self.choose_color)
        self.color_btn.pack(side=tk.LEFT, padx=5)
        
        self.eraser_btn = ttk.Button(self.toolbar, text="Silgi", command=self.use_eraser)
        self.eraser_btn.pack(side=tk.LEFT, padx=5)
        
        self.clear_btn = ttk.Button(self.toolbar, text="Temizle", command=self.clear_canvas)
        self.clear_btn.pack(side=tk.LEFT, padx=5)
        
        self.save_btn = ttk.Button(self.toolbar, text="Kaydet", command=self.save_file)
        self.save_btn.pack(side=tk.LEFT, padx=5)
        
        # Mod butonları
        self.move_btn = ttk.Button(self.toolbar, text="Hareket Et", command=self.toggle_move_mode)
        self.move_btn.pack(side=tk.LEFT, padx=5)
        self.draw_btn = ttk.Button(self.toolbar, text="Çiz", command=self.toggle_draw_mode)
        self.draw_btn.pack(side=tk.LEFT, padx=5)
        self.move_mode = False  # Varsayılan: Çizim modu
        
        # Sayfa navigasyon butonları
        self.prev_btn = ttk.Button(self.toolbar, text="Önceki Sayfa", command=self.prev_page)
        self.prev_btn.pack(side=tk.LEFT, padx=5)
        
        self.next_btn = ttk.Button(self.toolbar, text="Sonraki Sayfa", command=self.next_page)
        self.next_btn.pack(side=tk.LEFT, padx=5)
        
        self.page_label = ttk.Label(self.toolbar, text="Sayfa: 1/1")
        self.page_label.pack(side=tk.LEFT, padx=5)
        
        # Fırça boyutu
        ttk.Label(self.toolbar, text="Fırça Boyutu:").pack(side=tk.LEFT, padx=5)
        self.brush_size_entry = ttk.Entry(self.toolbar, width=5)
        self.brush_size_entry.insert(0, "5")
        self.brush_size_entry.pack(side=tk.LEFT, padx=5)
        self.brush_size_entry.bind("<Return>", self.set_brush_size)
        
        # Zoom seviyesi (%)
        ttk.Label(self.toolbar, text="Zoom (%):").pack(side=tk.LEFT, padx=5)
        self.zoom_entry = ttk.Entry(self.toolbar, width=5)
        self.zoom_entry.insert(0, "100")
        self.zoom_entry.pack(side=tk.LEFT, padx=5)
        self.zoom_entry.bind("<Return>", self.set_zoom)
        
        # Ana çerçeve ve scrollbar
        self.main_frame = ttk.Frame(self.root)
        self.main_frame.pack(fill=tk.BOTH, expand=True)
        
        # Scrollbar
        self.scrollbar = ttk.Scrollbar(self.main_frame, orient=tk.VERTICAL)
        self.scrollbar.pack(side=tk.RIGHT, fill=tk.Y)
        
        # Canvas
        self.canvas = tk.Canvas(self.main_frame, bg="#F0F0F0", width=1100, height=700, yscrollcommand=self.scrollbar.set)
        self.canvas.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)
        self.scrollbar.config(command=self.canvas.yview)
        
        # Değişkenler
        self.brush_color = "black"
        self.brush_size = 5
        self.zoom_level = 1.0  # 100% = 1.0
        self.old_x = None
        self.old_y = None
        self.strokes = {}  # Sayfa bazında strokes: {page_index: [(stroke, color), ...]}
        self.current_stroke = []
        self.pages = []  # Tüm sayfaların orijinal görüntüleri (PIL Image listesi)
        self.display_image = None  # Zoomlanmış görüntü
        self.image_item = None  # Canvas'taki görüntü item
        self.file_path = None
        self.is_pdf = False
        self.current_page = 0  # Mevcut sayfa indeksi
        self.animating = False  # Animasyon devam ediyor mu?
        self.drag_start_x = None
        self.drag_start_y = None
        
        # Fare olayları
        self.canvas.bind("<Button-1>", self.start_event)
        self.canvas.bind("<B1-Motion>", self.handle_event)
        self.canvas.bind("<ButtonRelease-1>", self.end_event)
        self.canvas.bind("<MouseWheel>", self.handle_wheel_smooth)
    
    def start_event(self, event):
        if self.move_mode:
            self.start_drag(event)
        else:
            self.old_x = self.canvas.canvasx(event.x)
            self.old_y = self.canvas.canvasy(event.y)
    
    def handle_event(self, event):
        if self.move_mode:
            self.drag(event)
        else:
            self.draw(event)
    
    def end_event(self, event):
        if not self.move_mode and self.current_stroke:
            self.strokes[self.current_page].append((self.current_stroke, self.brush_color))
            self.current_stroke = []
        self.old_x = None
        self.old_y = None
        self.drag_start_x = None
        self.drag_start_y = None
    
    def start_drag(self, event):
        self.drag_start_x = self.canvas.canvasx(event.x)
        self.drag_start_y = self.canvas.canvasy(event.y)
    
    def drag(self, event):
        if self.drag_start_x is not None and self.drag_start_y is not None:
            current_x = self.canvas.canvasx(event.x)
            current_y = self.canvas.canvasy(event.y)
            dx = current_x - self.drag_start_x
            dy = current_y - self.drag_start_y
            self.canvas.move(self.image_item, dx, dy)
            self.drag_start_x = current_x
            self.drag_start_y = current_y
            # Strokes'ları güncelle (eğer varsa)
            for stroke_list in self.strokes.get(self.current_page, []):
                stroke, _ = stroke_list
                for point in stroke:
                    point[0] += dx / self.zoom_level
                    point[1] += dy / self.zoom_level
    
    def toggle_move_mode(self):
        self.move_mode = True
        self.move_btn.config(style='TButton', background='#d0d0d0')
        self.draw_btn.config(style='TButton', background='#f0f0f0')
    
    def toggle_draw_mode(self):
        self.move_mode = False
        self.move_btn.config(style='TButton', background='#f0f0f0')
        self.draw_btn.config(style='TButton', background='#d0d0d0')
    
    def load_file(self):
        file_path = filedialog.askopenfilename(filetypes=[("PDF/PNG", "*.pdf *.png")])
        if not file_path:
            return
        self.file_path = file_path
        self.clear_canvas(full_clear=True)
        
        try:
            if file_path.lower().endswith('.pdf'):
                self.is_pdf = True
                doc = fitz.open(file_path)
                self.pages = []
                for page_num in range(len(doc)):
                    page = doc.load_page(page_num)
                    pix = page.get_pixmap(matrix=fitz.Matrix(2, 2))  # Yüksek çözünürlük
                    img_data = pix.tobytes("png")
                    img = Image.open(io.BytesIO(img_data))
                    self.pages.append(img)
                doc.close()
                self.strokes = {i: [] for i in range(len(self.pages))}  # Her sayfa için strokes
                self.current_page = 0
                self.update_page_label()
            else:
                self.is_pdf = False
                img = Image.open(file_path)
                self.pages = [img]  # PNG için tek sayfa
                self.strokes = {0: []}
                self.current_page = 0
                self.update_page_label()
            
            self.update_display_image()
        except Exception as e:
            messagebox.showerror("Hata", f"Dosya yüklenemedi: {e}")
    
    def update_display_image(self, animate=False):
        if not self.pages:
            return
        
        self.original_image = self.pages[self.current_page]
        width, height = self.original_image.size
        new_width = int(width * self.zoom_level)
        new_height = int(height * self.zoom_level)
        resized = self.original_image.resize((new_width, new_height), Image.LANCZOS)
        self.display_image = ImageTk.PhotoImage(resized)
        
        canvas_width = self.canvas.winfo_width()
        canvas_height = self.canvas.winfo_height()
        x_offset = (canvas_width - new_width) / 2 if new_width < canvas_width else 0
        y_offset = (canvas_height - new_height) / 2 if new_height < canvas_height else 0
        
        if animate:
            self.animate_transition(x_offset, y_offset)
        else:
            if self.image_item:
                self.canvas.delete(self.image_item)
            self.image_item = self.canvas.create_image(x_offset, y_offset, anchor=tk.NW, image=self.display_image)
            self.canvas.config(scrollregion=self.canvas.bbox("all"))
            self.redraw_strokes()
    
    def animate_transition(self, x_offset, y_offset):
        self.animating = True
        alpha = 0
        def fade_in():
            nonlocal alpha
            if alpha < 255:
                alpha += 25  # Yavaş artış
                self.root.after(50, fade_in)
            else:
                self.animating = False
        
        self.canvas.delete(self.image_item)
        self.image_item = self.canvas.create_image(x_offset, y_offset, anchor=tk.NW, image=self.display_image)
        self.canvas.config(scrollregion=self.canvas.bbox("all"))
        self.redraw_strokes()
        fade_in()
    
    def prev_page(self):
        if self.current_page > 0 and not self.animating:
            self.current_page -= 1
            self.update_page_label()
            self.update_display_image(animate=True)
    
    def next_page(self):
        if self.current_page < len(self.pages) - 1 and not self.animating:
            self.current_page += 1
            self.update_page_label()
            self.update_display_image(animate=True)
    
    def update_page_label(self):
        self.page_label.config(text=f"Sayfa: {self.current_page + 1}/{len(self.pages)}")
    
    def draw(self, event):
        if self.animating:
            return
        x, y = event.x, event.y
        scaled_x = (x - self.canvas.canvasx(0)) / self.zoom_level
        scaled_y = (y - self.canvas.canvasy(0)) / self.zoom_level
        if self.old_x and self.old_y:
            self.canvas.create_line(
                self.old_x, self.old_y, x, y,
                width=self.brush_size, fill=self.brush_color,
                capstyle=tk.ROUND, smooth=tk.TRUE
            )
            self.current_stroke.append([scaled_x, scaled_y])
        self.old_x, self.old_y = x, y
    
    def redraw_strokes(self):
        for stroke, color in self.strokes.get(self.current_page, []):
            for i in range(1, len(stroke)):
                x1, y1 = stroke[i-1]
                x2, y2 = stroke[i]
                self.canvas.create_line(
                    x1 * self.zoom_level + self.canvas.canvasx(0), y1 * self.zoom_level + self.canvas.canvasy(0),
                    x2 * self.zoom_level + self.canvas.canvasx(0), y2 * self.zoom_level + self.canvas.canvasy(0),
                    width=self.brush_size, fill=color,
                    capstyle=tk.ROUND, smooth=tk.TRUE
                )
    
    def choose_color(self):
        color = colorchooser.askcolor(title="Renk Seç")[1]
        if color:
            self.brush_color = color
    
    def use_eraser(self):
        self.brush_color = "white"
    
    def clear_canvas(self, full_clear=False):
        self.canvas.delete("all")
        if full_clear:
            self.strokes = {}
            self.pages = []
            self.current_page = 0
            self.update_page_label()
        else:
            self.strokes[self.current_page] = []
            self.current_stroke = []
        self.update_display_image()
    
    def set_brush_size(self, event=None):
        try:
            size = int(self.brush_size_entry.get())
            if 1 <= size <= 20:
                self.brush_size = size
            else:
                messagebox.showwarning("Uyarı", "Fırça boyutu 1-20 arası olmalı.")
        except ValueError:
            messagebox.showwarning("Uyarı", "Geçerli sayı girin.")
    
    def set_zoom(self, event=None):
        try:
            percent = int(self.zoom_entry.get())
            if 50 <= percent <= 200:
                self.zoom_level = percent / 100.0
                self.update_display_image()
            else:
                messagebox.showwarning("Uyarı", "Zoom 50-200% arası olmalı.")
        except ValueError:
            messagebox.showwarning("Uyarı", "Geçerli sayı girin.")
    
    def handle_wheel_smooth(self, event):
        if self.is_pdf and not self.animating:
            if event.delta > 0 and self.current_page > 0:
                self.current_page -= 1
            elif event.delta < 0 and self.current_page < len(self.pages) - 1:
                self.current_page += 1
            self.update_page_label()
            self.update_display_image(animate=True)
    
    def save_file(self):
        if not self.file_path:
            messagebox.showwarning("Uyarı", "Önce dosya yükleyin.")
            return
        
        save_path = filedialog.asksaveasfilename(defaultextension=".pdf" if self.is_pdf else ".png")
        if not save_path:
            return
        
        if self.is_pdf:
            doc = fitz.open(self.file_path)
            for page_num in range(len(doc)):
                page = doc.load_page(page_num)
                for stroke, color in self.strokes.get(page_num, []):
                    ink_points = [[point for point in stroke]]
                    annot = page.add_ink_annot(ink_points)
                    rgb = tuple(int(color.lstrip('#')[i:i+2], 16) / 255 for i in (0, 2, 4))
                    annot.set_colors(stroke=rgb)
                    annot.update()
            doc.save(save_path)
            doc.close()
        else:
            self.canvas.postscript(file="temp.ps")
            img = Image.open("temp.ps")
            img.save(save_path)
            os.remove("temp.ps")
        
        messagebox.showinfo("Bilgi", "Dosya kaydedildi.")

if __name__ == "__main__":
    # Giriş ekranı
    splash_root = tk.Tk()
    splash = SplashScreen(splash_root)
    splash_root.mainloop()
    
    # Ana uygulama
    root = tk.Tk()
    app = DrawingApp(root)
    root.mainloop()
